@echo off & CHCP 65001>nul

title EA Launcher Wrapper for %GameEXE%

:: Configuration Settings
:: Your games executable name
set "GameEXE=BF2042.exe"
:: Minimize mode, controls how the CMD window is minimzed while monitoring for the game. 
:: Valid options: 1 or 2
set "MinimizeModeChoice=2"
:: EA Services executables
set "EAServices=EADesktop.exe EABackgroundService.exe"

:: Don't change anything below here
cd /D "%~dp0"

:: Check for Game executable, if not found open the script in notepad.
for %%H in ("%GameEXE%") do (if not exist "%%H" (start Notepad.exe "%~f0" & exit))

    set __COMPAT_LAYER=RunAsInvoker
    call :MinimizeMode%MinimizeModeChoice%
	:: Do before game launch
	taskkill /IM DS4Windows.exe /F >nul 2>&1
	:: Launch game
	start "" "%GameEXE%"

	:: Wait for the game.exe to actually appear
	:waitForGame
	timeout /t 1 >nul
	tasklist /fi "imagename eq %GameEXE%" | find /i "%GameEXE%" >nul
	if errorlevel 1 goto waitForGame

	:: Once it appears, wait for it to exit
	PowerShell -NoProfile -Command "Wait-Process -Name ([System.IO.Path]::GetFileNameWithoutExtension($Env:GameEXE))"
    ::(PowerShell.exe -NoProfile -Command "While ($True) {If (Get-Process -Name ([System.IO.Path]::GetFileNameWithoutExtension($Env:GameEXE))) {Break} else {Start-Sleep -Seconds 3}}; Wait-Process -Name ([System.IO.Path]::GetFileNameWithoutExtension($Env:GameEXE))")>nul 2>&1
	:: Perform cleanup on EA Launcher
	for %%h in (%EAServices%) do (
		taskkill /F /IM %%h >nul 2>&1
	)
    exit

    :MinimizeMode1

        if "%HF%"=="?" (goto :EOF)
        set "HF=?"
        start /min cmd.exe /C call "%~f0"

    Exit

    :MinimizeMode2

        timeout.exe /T 2 /NoBreak>Nul
        start /B "" PowerShell.exe -NoProfile -WindowStyle Minimized -Command "exit"

    goto :EOF
